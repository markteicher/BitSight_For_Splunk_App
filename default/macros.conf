#
# Bitsight Search Macros
# Reusable search macros for common Bitsight queries
#

# ============================================================================
# BASE INDEX MACROS
# ============================================================================

[bitsight_index]
definition = index=security_bitsight
iseval = 0

[bitsight_portfolio]
definition = `bitsight_index` sourcetype=bitsight:portfolio
iseval = 0

[bitsight_ratings]
definition = `bitsight_index` sourcetype=bitsight:ratings
iseval = 0

[bitsight_ratings_history]
definition = `bitsight_index` sourcetype=bitsight:ratings:history
iseval = 0

[bitsight_findings]
definition = `bitsight_index` sourcetype=bitsight:findings
iseval = 0

[bitsight_findings_compromised]
definition = `bitsight_index` sourcetype=bitsight:findings:compromised
iseval = 0

[bitsight_findings_diligence]
definition = `bitsight_index` sourcetype=bitsight:findings:diligence
iseval = 0

[bitsight_credentials]
definition = `bitsight_index` sourcetype=bitsight:credentials
iseval = 0

[bitsight_alerts]
definition = `bitsight_index` sourcetype=bitsight:alerts
iseval = 0

[bitsight_threats]
definition = `bitsight_index` sourcetype=bitsight:threats
iseval = 0

[bitsight_users]
definition = `bitsight_index` sourcetype=bitsight:users
iseval = 0

# ============================================================================
# RATING CLASSIFICATION MACROS
# ============================================================================

[rating_category(1)]
args = rating_field
definition = eval rating_category=case($rating_field$ >= 740, "Advanced", $rating_field$ >= 640, "Good", $rating_field$ >= 500, "Fair", $rating_field$ >= 300, "Poor", true(), "Critical")
iseval = 0

[rating_color(1)]
args = rating_field
definition = eval rating_color=case($rating_field$ >= 740, "#2ecc71", $rating_field$ >= 640, "#27ae60", $rating_field$ >= 500, "#f39c12", $rating_field$ >= 300, "#e74c3c", true(), "#c0392b")
iseval = 0

[risk_level(1)]
args = rating_field
definition = eval risk_level=case($rating_field$ >= 740, "Low", $rating_field$ >= 640, "Moderate", $rating_field$ >= 500, "High", $rating_field$ >= 300, "Very High", true(), "Critical")
iseval = 0

[rating_trend(2)]
args = current_rating, previous_rating
definition = eval rating_change=$current_rating$ - $previous_rating$, trend=if($current_rating$ > $previous_rating$, "improving", if($current_rating$ < $previous_rating$, "declining", "stable")), trend_icon=if($current_rating$ > $previous_rating$, "▲", if($current_rating$ < $previous_rating$, "▼", "―"))
iseval = 0

# ============================================================================
# SEVERITY CLASSIFICATION MACROS
# ============================================================================

[severity_level(1)]
args = severity_field
definition = eval severity_numeric=case(lower($severity_field$)="critical", 5, lower($severity_field$)="severe", 5, lower($severity_field$)="high", 4, lower($severity_field$)="medium", 3, lower($severity_field$)="moderate", 3, lower($severity_field$)="low", 2, lower($severity_field$)="informational", 1, true(), 0)
iseval = 0

[severity_color(1)]
args = severity_field
definition = eval severity_color=case(lower($severity_field$)="critical", "#c0392b", lower($severity_field$)="severe", "#c0392b", lower($severity_field$)="high", "#e74c3c", lower($severity_field$)="medium", "#f39c12", lower($severity_field$)="moderate", "#f39c12", lower($severity_field$)="low", "#3498db", true(), "#95a5a6")
iseval = 0

# ============================================================================
# RISK VECTOR MACROS
# ============================================================================

[compromised_vectors]
definition = risk_vector IN ("botnet_infections", "spam_propagation", "malware_servers", "unsolicited_comm", "potentially_exploited")
iseval = 0

[diligence_vectors]
definition = risk_vector IN ("spf", "dkim", "ssl_certificates", "ssl_configurations", "open_ports", "web_appsec", "patching_cadence", "insecure_systems", "server_software", "desktop_software", "mobile_software", "dnssec", "mobile_application_security", "application_security", "dmarc")
iseval = 0

[user_behavior_vectors]
definition = risk_vector IN ("file_sharing", "potentially_unwanted_programs")
iseval = 0

[risk_vector_category(1)]
args = vector_field
definition = eval risk_category=case(match($vector_field$, "botnet_infections|spam_propagation|malware_servers|unsolicited_comm|potentially_exploited"), "Compromised Systems", match($vector_field$, "spf|dkim|dmarc|dnssec"), "Email Security", match($vector_field$, "ssl_certificates|ssl_configurations"), "SSL/TLS", match($vector_field$, "open_ports|web_appsec|application_security"), "Network Security", match($vector_field$, "patching_cadence|server_software|desktop_software|mobile_software|insecure_systems"), "Patching & Software", match($vector_field$, "file_sharing|potentially_unwanted_programs"), "User Behavior", true(), "Other")
iseval = 0

# ============================================================================
# TIME-BASED MACROS
# ============================================================================

[last_hour]
definition = earliest=-1h@h latest=now
iseval = 0

[last_24h]
definition = earliest=-24h@h latest=now
iseval = 0

[last_7d]
definition = earliest=-7d@d latest=now
iseval = 0

[last_30d]
definition = earliest=-30d@d latest=now
iseval = 0

[last_90d]
definition = earliest=-90d@d latest=now
iseval = 0

[last_365d]
definition = earliest=-365d@d latest=now
iseval = 0

[this_week]
definition = earliest=-7d@w1 latest=@w1
iseval = 0

[this_month]
definition = earliest=@mon latest=now
iseval = 0

[last_month]
definition = earliest=-1mon@mon latest=@mon
iseval = 0

# ============================================================================
# COMPANY FILTER MACROS
# ============================================================================

[company(1)]
args = company_name
definition = search company_name="$company_name$"
iseval = 0

[company_guid(1)]
args = guid
definition = search company_guid="$guid$"
iseval = 0

[tier(1)]
args = tier_name
definition = search tier="$tier_name$"
iseval = 0

[industry(1)]
args = industry_name
definition = search industry="$industry_name$"
iseval = 0

# ============================================================================
# AGGREGATION MACROS
# ============================================================================

[rating_stats_by_company]
definition = stats latest(rating) as current_rating earliest(rating) as first_rating min(rating) as min_rating max(rating) as max_rating avg(rating) as avg_rating by company_name company_guid
iseval = 0

[findings_count_by_severity]
definition = stats count as total count(eval(severity="critical")) as critical count(eval(severity="high")) as high count(eval(severity="medium")) as medium count(eval(severity="low")) as low by company_name company_guid
iseval = 0

[findings_count_by_vector]
definition = stats count as finding_count dc(asset) as affected_assets by company_name company_guid risk_vector
iseval = 0

[credential_stats]
definition = stats count as total_exposures dc(email) as unique_emails dc(breach_name) as breach_sources latest(breach_date) as latest_breach by company_name company_guid
iseval = 0

# ============================================================================
# TRENDING MACROS
# ============================================================================

[wow_change(1)]
args = metric_field
definition = eventstats avg($metric_field$) as current_week_avg by company_name | eventstats avg(eval(if(_time < relative_time(now(), "-7d"), $metric_field$, null()))) as prev_week_avg by company_name | eval wow_change=round(((current_week_avg - prev_week_avg) / prev_week_avg) * 100, 2)
iseval = 0

[mom_change(1)]
args = metric_field
definition = eventstats avg($metric_field$) as current_month_avg by company_name | eventstats avg(eval(if(_time < relative_time(now(), "-1mon"), $metric_field$, null()))) as prev_month_avg by company_name | eval mom_change=round(((current_month_avg - prev_month_avg) / prev_month_avg) * 100, 2)
iseval = 0

[qoq_change(1)]
args = metric_field
definition = eventstats avg($metric_field$) as current_quarter_avg by company_name | eventstats avg(eval(if(_time < relative_time(now(), "-3mon"), $metric_field$, null()))) as prev_quarter_avg by company_name | eval qoq_change=round(((current_quarter_avg - prev_quarter_avg) / prev_quarter_avg) * 100, 2)
iseval = 0

[yoy_change(1)]
args = metric_field
definition = eventstats avg($metric_field$) as current_year_avg by company_name | eventstats avg(eval(if(_time < relative_time(now(), "-1y"), $metric_field$, null()))) as prev_year_avg by company_name | eval yoy_change=round(((current_year_avg - prev_year_avg) / prev_year_avg) * 100, 2)
iseval = 0

# ============================================================================
# THRESHOLD MACROS
# ============================================================================

[critical_rating_threshold]
definition = rating < 500
iseval = 0

[high_risk_threshold]
definition = rating < 600
iseval = 0

[acceptable_rating_threshold]
definition = rating >= 640
iseval = 0

[excellent_rating_threshold]
definition = rating >= 740
iseval = 0

# ============================================================================
# FORMATTING MACROS
# ============================================================================

[format_rating(1)]
args = rating_field
definition = eval rating_display=tostring($rating_field$, "commas")
iseval = 0

[format_timestamp(1)]
args = time_field
definition = eval formatted_time=strftime($time_field$, "%Y-%m-%d %H:%M:%S")
iseval = 0

[format_date(1)]
args = time_field
definition = eval formatted_date=strftime($time_field$, "%Y-%m-%d")
iseval = 0

[format_percent(1)]
args = value_field
definition = eval percent_display=tostring(round($value_field$, 2)) . "%"
iseval = 0

# ============================================================================
# LOOKUP ENRICHMENT MACROS
# ============================================================================

[enrich_risk_vector]
definition = lookup bitsight_risk_vectors risk_vector OUTPUT risk_category risk_description
iseval = 0

[enrich_severity]
definition = lookup bitsight_severity_levels severity OUTPUT severity_name severity_color severity_priority
iseval = 0

[enrich_rating_category]
definition = lookup bitsight_rating_categories rating_range OUTPUTNEW category_name category_description
iseval = 0

# ============================================================================
# DASHBOARD HELPER MACROS
# ============================================================================

[portfolio_overview]
definition = `bitsight_portfolio` | `rating_stats_by_company` | `rating_category(current_rating)` | `risk_level(current_rating)` | table company_name company_guid current_rating rating_category risk_level
iseval = 0

[findings_summary]
definition = `bitsight_findings` | `findings_count_by_severity` | table company_name company_guid total critical high medium low
iseval = 0

[credentials_summary]
definition = `bitsight_credentials` | `credential_stats` | table company_name company_guid total_exposures unique_emails breach_sources latest_breach
iseval = 0

[top_risk_companies(1)]
args = limit
definition = `bitsight_portfolio` | stats latest(rating) as rating by company_name company_guid | sort rating | head $limit$ | `rating_category(rating)` | `risk_level(rating)`
iseval = 0

[recent_critical_findings(1)]
args = hours
definition = `bitsight_findings` earliest=-$hours$h severity IN ("critical", "severe", "high") | table _time company_name risk_vector severity asset details
iseval = 0
