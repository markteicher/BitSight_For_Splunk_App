<?xml version="1.0" encoding="UTF-8"?>
<dashboard>
  <label>Bitsight Findings</label>
  <description>Security Findings and Vulnerabilities</description>
  
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="timerange" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="severity_filter" searchWhenChanged="true">
      <label>Severity</label>
      <choice value="*">All Severities</choice>
      <choice value="severe">Severe</choice>
      <choice value="material">Material</choice>
      <choice value="moderate">Moderate</choice>
      <choice value="minor">Minor</choice>
      <default>*</default>
    </input>
    <input type="dropdown" token="risk_vector_filter" searchWhenChanged="true">
      <label>Risk Vector</label>
      <choice value="*">All Risk Vectors</choice>
      <default>*</default>
      <fieldForLabel>risk_vector</fieldForLabel>
      <fieldForValue>risk_vector</fieldForValue>
      <search>
        <query>
          index=security_bitsight sourcetype="bitsight:findings" 
          | dedup risk_vector 
          | table risk_vector 
          | sort risk_vector
        </query>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </search>
    </input>
    <input type="dropdown" token="company_filter" searchWhenChanged="true">
      <label>Company</label>
      <choice value="*">All Companies</choice>
      <default>*</default>
      <fieldForLabel>company_name</fieldForLabel>
      <fieldForValue>company_guid</fieldForValue>
      <search>
        <query>
          index=security_bitsight sourcetype="bitsight:findings" 
          | dedup company_guid 
          | table company_guid, company_name 
          | sort company_name
        </query>
        <earliest>-30d@d</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <title>Total Findings</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <title>Severe Findings</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" severity="severe"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[0,10]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Material Findings</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" severity="material"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xf1813f"]</option>
        <option name="rangeValues">[0,20]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Unique Risk Vectors</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats dc(risk_vector) as count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Findings Over Time</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | timechart span=1d count by severity
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">area</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"severe": 0xdc4e41, "material": 0xf1813f, "moderate": 0xf8be34, "minor": 0x53a051}</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Findings by Severity</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count by severity
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.fieldColors">{"severe": 0xdc4e41, "material": 0xf1813f, "moderate": 0xf8be34, "minor": 0x53a051}</option>
      </chart>
    </panel>
    <panel>
      <title>Findings by Risk Vector</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count by risk_vector
            | sort -count
            | head 15
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.axisTitleX.text">Risk Vector</option>
        <option name="charting.axisTitleY.text">Finding Count</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Top Companies by Finding Count</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | stats count by company_name
            | sort -count
            | head 10
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.axisTitleX.text">Company</option>
        <option name="charting.axisTitleY.text">Finding Count</option>
      </chart>
    </panel>
    <panel>
      <title>Finding Status Distribution</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | eval status=if(isnull(remediated_date) OR remediated_date="", "Open", "Remediated")
            | stats count by status
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Open": 0xdc4e41, "Remediated": 0x53a051}</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Assets with Findings</title>
      <table>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count as finding_count, values(severity) as severities by asset, asset_type, company_name
            | sort -finding_count
            | head 50
            | rename asset as "Asset", asset_type as "Asset Type", company_name as "Company", finding_count as "Findings", severities as "Severities"
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
      </table>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Finding Details</title>
      <table>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:findings" 
            | where severity="$severity_filter$" OR "$severity_filter$"="*"
            | where risk_vector="$risk_vector_filter$" OR "$risk_vector_filter$"="*"
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | eval first_seen_date=strftime(strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), "%Y-%m-%d")
            | eval status=if(isnull(remediated_date) OR remediated_date="", "Open", "Remediated")
            | table first_seen_date, company_name, risk_vector, severity, asset, asset_type, details, status
            | rename first_seen_date as "First Seen", company_name as "Company", risk_vector as "Risk Vector", severity as "Severity", asset as "Asset", asset_type as "Asset Type", details as "Details", status as "Status"
            | sort -"First Seen"
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">row</option>
        <option name="percentagesRow">false</option>
        <option name="rowNumbers">true</option>
        <option name="totalsRow">false</option>
        <option name="wrap">true</option>
        <format type="color" field="Severity">
          <colorPalette type="map">{"severe":#dc4e41,"material":#f1813f,"moderate":#f8be34,"minor":#53a051}</colorPalette>
        </format>
        <format type="color" field="Status">
          <colorPalette type="map">{"Open":#dc4e41,"Remediated":#53a051}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
</dashboard>