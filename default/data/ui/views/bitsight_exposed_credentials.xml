<?xml version="1.0" encoding="UTF-8"?>
<dashboard>
  <label>Bitsight Exposed Credentials</label>
  <description>Exposed Credentials and Data Breach Tracking</description>
  
  <fieldset submitButton="true" autoRun="true">
    <input type="time" token="timerange" searchWhenChanged="true">
      <label>Time Range</label>
      <default>
        <earliest>-90d@d</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="company_filter" searchWhenChanged="true">
      <label>Company</label>
      <choice value="*">All Companies</choice>
      <default>*</default>
      <fieldForLabel>company_name</fieldForLabel>
      <fieldForValue>company_guid</fieldForValue>
      <search>
        <query>
          index=security_bitsight sourcetype="bitsight:exposed_credentials" 
          | dedup company_guid 
          | table company_guid, company_name 
          | sort company_name
        </query>
        <earliest>-90d@d</earliest>
        <latest>now</latest>
      </search>
    </input>
  </fieldset>
  
  <row>
    <panel>
      <title>Total Exposed Credentials</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats sum(credential_count) as total
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <option name="colorMode">block</option>
        <option name="rangeColors">["0x53a051","0xf8be34","0xdc4e41"]</option>
        <option name="rangeValues">[100,1000]</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>Breach Events</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats dc(breach_id) as count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
    <panel>
      <title>Companies Affected</title>
      <single>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | stats dc(company_guid) as count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Exposed Credentials Over Time</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | timechart span=1w sum(credential_count) as "Exposed Credentials"
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">column</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Top Companies by Exposed Credentials</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | stats sum(credential_count) as total by company_name
            | sort -total
            | head 10
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">bar</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
    <panel>
      <title>Breaches by Source</title>
      <chart>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | stats count by breach_source
            | sort -count
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="charting.chart">pie</option>
        <option name="charting.drilldown">none</option>
      </chart>
    </panel>
  </row>
  
  <row>
    <panel>
      <title>Breach Details</title>
      <table>
        <search>
          <query>
            index=security_bitsight sourcetype="bitsight:exposed_credentials" 
            | where company_guid="$company_filter$" OR "$company_filter$"="*"
            | eval breach_date_fmt=strftime(strptime(breach_date, "%Y-%m-%dT%H:%M:%S"), "%Y-%m-%d")
            | table breach_date_fmt, company_name, breach_source, breach_description, credential_count
            | rename breach_date_fmt as "Breach Date", company_name as "Company", breach_source as "Source", breach_description as "Description", credential_count as "Credentials"
            | sort -"Breach Date"
          </query>
          <earliest>$timerange.earliest$</earliest>
          <latest>$timerange.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="drilldown">row</option>
        <option name="rowNumbers">true</option>
        <format type="color" field="Credentials">
          <colorPalette type="minMidMax" maxColor="#DC4E41" midColor="#F8BE34" minColor="#53A051"></colorPalette>
          <scale type="minMidMax" midType="percentile" midValue="50"></scale>
        </format>
      </table>
    </panel>
  </row>
</dashboard>