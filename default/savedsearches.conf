#
# Bitsight Saved Searches and Correlation Rules
# Pre-built searches for security monitoring and alerting
#

# ============================================================================
# RATING MONITORING
# ============================================================================

[Bitsight - Rating Drop Alert]
description = Alert when any company's security rating drops
search = index=security_bitsight sourcetype=bitsight:ratings \
| stats latest(rating) as current_rating earliest(rating) as previous_rating by company_name company_guid \
| eval rating_change = current_rating - previous_rating \
| where rating_change < 0 \
| eval severity = case(rating_change <= -50, "critical", rating_change <= -20, "high", rating_change <= -10, "medium", true(), "low") \
| table company_name company_guid previous_rating current_rating rating_change severity
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 */4 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.suppress = 1
alert.suppress.period = 24h
alert.suppress.fields = company_guid
alert.track = 1
action.email = 0
action.bitsight_webhook_alert = 0

[Bitsight - Critical Rating Threshold]
description = Alert when any company falls below critical rating threshold (below 500)
search = index=security_bitsight sourcetype=bitsight:ratings rating<500 \
| stats latest(rating) as rating latest(_time) as last_seen by company_name company_guid \
| eval severity = case(rating < 300, "critical", rating < 400, "high", rating < 500, "medium") \
| table company_name company_guid rating severity last_seen \
| convert ctime(last_seen)
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

[Bitsight - Rating Trend Analysis]
description = Weekly rating trend analysis for all monitored companies
search = index=security_bitsight sourcetype=bitsight:ratings:history \
| timechart span=1d avg(rating) as avg_rating by company_name \
| streamstats window=7 avg(avg_rating) as weekly_avg by company_name \
| eval trend = if(avg_rating > weekly_avg, "improving", "declining")
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 6 * * 1
enableSched = 1
is_visible = 1
disabled = 0

# ============================================================================
# FINDINGS MONITORING
# ============================================================================

[Bitsight - Critical Findings Alert]
description = Alert on new critical severity findings
search = index=security_bitsight sourcetype=bitsight:findings severity="critical" OR severity="severe" \
| stats count as finding_count values(risk_vector) as risk_vectors values(asset) as affected_assets by company_name company_guid \
| where finding_count > 0 \
| table company_name company_guid finding_count risk_vectors affected_assets
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

[Bitsight - New Findings Summary]
description = Daily summary of new findings across all companies
search = index=security_bitsight sourcetype=bitsight:findings \
| stats count as total_findings \
    count(eval(severity="critical")) as critical \
    count(eval(severity="high")) as high \
    count(eval(severity="medium")) as medium \
    count(eval(severity="low")) as low \
    dc(company_name) as companies_affected \
    dc(risk_vector) as risk_vectors_affected \
    by _time \
| timechart span=1d sum(total_findings) as findings sum(critical) as critical sum(high) as high
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0

[Bitsight - Compromised Systems Detected]
description = Alert on botnet infections, malware, or compromised systems
search = index=security_bitsight sourcetype=bitsight:findings:compromised \
| search risk_vector IN ("botnet_infections", "spam_propagation", "malware_servers", "potentially_exploited") \
| stats count as infection_count values(asset) as affected_assets values(details) as details by company_name company_guid risk_vector \
| table company_name company_guid risk_vector infection_count affected_assets details
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = */30 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

[Bitsight - Open Ports Detected]
description = Alert on dangerous open ports discovered
search = index=security_bitsight sourcetype=bitsight:findings risk_vector="open_ports" \
| rex field=details "port[:\s]+(?<port>\d+)" \
| search port IN (21, 22, 23, 25, 135, 137, 138, 139, 445, 1433, 1434, 3306, 3389, 5432, 5900, 5901) \
| stats count as open_port_count values(port) as dangerous_ports values(asset) as affected_assets by company_name company_guid \
| table company_name company_guid dangerous_ports open_port_count affected_assets
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 */6 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

[Bitsight - SSL Certificate Issues]
description = Alert on SSL certificate vulnerabilities or expirations
search = index=security_bitsight sourcetype=bitsight:findings risk_vector IN ("ssl_certificates", "ssl_configurations") \
| stats count as ssl_issues values(details) as issue_details values(asset) as affected_assets by company_name company_guid severity \
| table company_name company_guid severity ssl_issues issue_details affected_assets
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 7 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

[Bitsight - Patching Cadence Issues]
description = Alert on systems with poor patching practices
search = index=security_bitsight sourcetype=bitsight:findings risk_vector="patching_cadence" severity IN ("critical", "high") \
| stats count as patching_issues values(asset) as affected_assets by company_name company_guid \
| where patching_issues > 5 \
| table company_name company_guid patching_issues affected_assets
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

# ============================================================================
# CREDENTIAL EXPOSURE MONITORING
# ============================================================================

[Bitsight - Exposed Credentials Alert]
description = Alert on newly discovered exposed credentials (dark web monitoring)
search = index=security_bitsight sourcetype=bitsight:credentials \
| stats count as credential_count dc(email) as unique_emails values(breach_name) as breach_sources latest(breach_date) as latest_breach by company_name company_guid \
| where credential_count > 0 \
| eval severity = case(credential_count >= 100, "critical", credential_count >= 50, "high", credential_count >= 10, "medium", true(), "low") \
| table company_name company_guid credential_count unique_emails breach_sources latest_breach severity
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 */4 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.suppress = 1
alert.suppress.period = 24h
alert.suppress.fields = company_guid
alert.track = 1

[Bitsight - Executive Credential Exposure]
description = Alert on exposed credentials for executive-level accounts
search = index=security_bitsight sourcetype=bitsight:credentials \
| search email="*ceo*" OR email="*cfo*" OR email="*cto*" OR email="*ciso*" OR email="*president*" OR email="*director*" OR email="*vp@*" OR email="*vice.president*" \
| stats count as exec_credentials values(email) as exposed_emails values(breach_name) as breach_sources by company_name company_guid \
| table company_name company_guid exec_credentials exposed_emails breach_sources
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 9 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

[Bitsight - Credential Breach Trend]
description = Weekly trend of credential exposures
search = index=security_bitsight sourcetype=bitsight:credentials \
| timechart span=1d dc(email) as unique_credentials count as total_exposures by company_name
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 6 * * 1
enableSched = 1
is_visible = 1
disabled = 0

# ============================================================================
# THREAT INTELLIGENCE
# ============================================================================

[Bitsight - Active Threats Detected]
description = Alert on active threat indicators for monitored companies
search = index=security_bitsight sourcetype=bitsight:threats \
| stats count as threat_count values(threat_type) as threat_types values(indicator) as indicators by company_name company_guid \
| where threat_count > 0 \
| table company_name company_guid threat_count threat_types indicators
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = */30 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

# ============================================================================
# PORTFOLIO MONITORING
# ============================================================================

[Bitsight - Portfolio Risk Summary]
description = Daily portfolio risk summary report
search = index=security_bitsight sourcetype=bitsight:portfolio \
| stats latest(rating) as rating by company_name company_guid tier industry \
| eval risk_level = case(rating >= 740, "Low", rating >= 640, "Moderate", rating >= 500, "High", true(), "Critical") \
| stats count as company_count avg(rating) as avg_rating by risk_level \
| table risk_level company_count avg_rating
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 7 * * *
enableSched = 1
is_visible = 1
disabled = 0

[Bitsight - New Company Added to Portfolio]
description = Alert when a new company is added to monitoring
search = index=security_bitsight sourcetype=bitsight:portfolio \
| stats earliest(_time) as first_seen by company_name company_guid \
| where first_seen > relative_time(now(), "-24h") \
| table company_name company_guid first_seen \
| convert ctime(first_seen)
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 9 * * *
enableSched = 1
is_visible = 1
disabled = 0

[Bitsight - High Risk Vendors]
description = Report on vendors with ratings below acceptable threshold
search = index=security_bitsight sourcetype=bitsight:portfolio rating<600 \
| stats latest(rating) as rating values(industry) as industry by company_name company_guid tier \
| eval risk_assessment = case(rating < 400, "Unacceptable Risk", rating < 500, "High Risk - Action Required", rating < 600, "Elevated Risk - Monitor Closely") \
| sort rating \
| table company_name tier industry rating risk_assessment
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 8 * * 1
enableSched = 1
is_visible = 1
disabled = 0

# ============================================================================
# COMPLIANCE & REPORTING
# ============================================================================

[Bitsight - Weekly Executive Summary]
description = Weekly executive summary of security posture
search = index=security_bitsight sourcetype IN ("bitsight:portfolio", "bitsight:ratings", "bitsight:findings", "bitsight:credentials") \
| stats dc(company_name) as monitored_companies avg(rating) as avg_rating count(eval(sourcetype="bitsight:findings" AND severity="critical")) as critical_findings count(eval(sourcetype="bitsight:credentials")) as credential_exposures \
| eval report_date = strftime(now(), "%Y-%m-%d") \
| table report_date monitored_companies avg_rating critical_findings credential_exposures
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 8 * * 1
enableSched = 1
is_visible = 1
disabled = 0

[Bitsight - Monthly Risk Report]
description = Monthly comprehensive risk assessment report
search = index=security_bitsight sourcetype=bitsight:ratings:history \
| stats earliest(rating) as month_start_rating latest(rating) as month_end_rating by company_name company_guid \
| eval rating_change = month_end_rating - month_start_rating \
| eval trend = if(rating_change > 0, "Improved", if(rating_change < 0, "Declined", "Stable")) \
| table company_name month_start_rating month_end_rating rating_change trend
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 6 1 * *
enableSched = 1
is_visible = 1
disabled = 0

# ============================================================================
# ALERT CORRELATION
# ============================================================================

[Bitsight - Multi-Vector Attack Indicator]
description = Correlate multiple risk vectors indicating coordinated attack
search = index=security_bitsight sourcetype=bitsight:findings \
| stats dc(risk_vector) as vector_count values(risk_vector) as risk_vectors count as finding_count by company_name company_guid _time \
| where vector_count >= 3 AND finding_count >= 10 \
| eval alert_message = "Multiple attack vectors detected: " . mvjoin(risk_vectors, ", ") \
| table _time company_name company_guid vector_count finding_count alert_message
dispatch.earliest_time = -1h@h
dispatch.latest_time = now
cron_schedule = */15 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

[Bitsight - Rapid Rating Degradation]
description = Alert on rapid rating drops indicating active compromise
search = index=security_bitsight sourcetype=bitsight:ratings \
| streamstats window=2 current=f latest(rating) as prev_rating by company_guid \
| eval rating_drop = prev_rating - rating \
| where rating_drop >= 30 \
| table _time company_name company_guid prev_rating rating rating_drop
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1

# ============================================================================
# ADVANCED CORRELATION RULES
# ============================================================================

[Bitsight - NIST CSF Compliance Gap]
description = Alert when NIST CSF function scores fall below threshold
search = index=security_bitsight sourcetype=bitsight:risk_vectors \
| eval nist_function=case( \
    name IN ("dnssec", "spf", "dkim", "dmarc"), "Identify", \
    name IN ("ssl_certificates", "ssl_configurations", "open_ports", "patching_cadence", "server_software", "desktop_software", "mobile_software", "insecure_systems"), "Protect", \
    name IN ("botnet_infections", "malware_servers", "potentially_exploited", "spam_propagation", "unsolicited_comm"), "Detect", \
    name IN ("web_appsec", "application_security", "mobile_application_security"), "Respond", \
    1=1, "Recover" \
  ) \
| stats avg(rating) as function_score by company_name company_guid nist_function \
| where function_score < 500 \
| eval severity=case(function_score<300, "critical", function_score<400, "high", 1=1, "medium") \
| table company_name nist_function function_score severity
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

[Bitsight - SLA Breach Alert]
description = Alert when findings exceed SLA remediation timeframes
search = index=security_bitsight sourcetype=bitsight:findings \
| eval days_open=round((now() - strptime(first_seen, "%Y-%m-%dT%H:%M:%S"))/86400, 0) \
| eval sla_days=case(severity="critical", 7, severity="severe", 14, severity="high", 30, severity="moderate", 60, 1=1, 90) \
| where days_open > sla_days \
| eval days_overdue=days_open - sla_days \
| stats count as overdue_count sum(days_overdue) as total_days_overdue values(risk_vector) as risk_vectors by company_name company_guid severity \
| table company_name severity overdue_count total_days_overdue risk_vectors
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 9 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

[Bitsight - Peer Benchmark Deviation]
description = Alert when company rating deviates significantly from industry peers
search = index=security_bitsight sourcetype=bitsight:portfolio \
| dedup guid \
| eventstats avg(rating) as industry_avg stdev(rating) as industry_stdev by industry \
| eval z_score=(rating - industry_avg) / industry_stdev \
| where z_score < -2 \
| eval deviation_msg="Rating ".round(industry_avg - rating, 0)." points below industry average" \
| table name industry rating industry_avg z_score deviation_msg
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 7 * * 1
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

[Bitsight - Supply Chain Risk Cascade]
description = Correlate declining ratings across connected subsidiaries
search = index=security_bitsight sourcetype=bitsight:ratings_tree \
| spath \
| where is_bundled="true" \
| stats avg(rating) as subsidiary_avg, count as subsidiary_count, values(name) as subsidiaries by parent_guid \
| where subsidiary_avg < 550 AND subsidiary_count >= 3 \
| eval alert_msg="Multiple subsidiaries with degraded ratings" \
| table parent_guid subsidiary_count subsidiary_avg subsidiaries alert_msg
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 */6 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

[Bitsight - Data Collection Health Alert]
description = Alert when data collection is stale or failing
search = | tstats latest(_time) as last_event where index=security_bitsight by sourcetype \
| eval age_hours=round((now() - last_event)/3600, 2) \
| where age_hours > 24 \
| eval status="CRITICAL: No data for ".round(age_hours, 0)." hours" \
| table sourcetype last_event age_hours status
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 */2 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

[Bitsight - Anomalous Rating Change]
description = Detect unusual rating changes using statistical analysis
search = index=security_bitsight sourcetype=bitsight:ratings:history \
| streamstats window=30 avg(rating) as rolling_avg stdev(rating) as rolling_stdev by company_guid \
| eval z_score=if(rolling_stdev>0, (rating - rolling_avg) / rolling_stdev, 0) \
| where abs(z_score) > 3 \
| eval anomaly_type=if(z_score > 0, "Unusual Improvement", "Unusual Decline") \
| table _time company_name rating rolling_avg z_score anomaly_type
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 */4 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

[Bitsight - Combined Threat Indicator]
description = Correlate multiple threat signals across data sources
search = index=security_bitsight \
| stats count(eval(sourcetype="bitsight:findings" AND severity IN ("critical","severe"))) as critical_findings \
        count(eval(sourcetype="bitsight:credentials")) as credential_exposures \
        count(eval(sourcetype="bitsight:threats")) as threat_indicators \
        latest(eval(if(sourcetype="bitsight:portfolio", rating, null()))) as current_rating \
        by company_name company_guid \
| where critical_findings > 5 OR credential_exposures > 20 OR threat_indicators > 0 \
| eval risk_score=(critical_findings * 10) + (credential_exposures * 2) + (threat_indicators * 20) \
| eval risk_level=case(risk_score > 100, "Critical", risk_score > 50, "High", risk_score > 20, "Medium", 1=1, "Low") \
| table company_name current_rating critical_findings credential_exposures threat_indicators risk_score risk_level
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 * * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1

# ============================================================================
# MTTR SLA MONITORING
# ============================================================================

[Bitsight - MTTR SLA Breach - Critical Findings]
description = Alert when critical findings exceed 30-day MTTR SLA threshold
search = index=main sourcetype="bitsight:findings" severity="critical" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=round((last_epoch-first_epoch)/86400, 1) \
| where mttr_days > 30 \
| eval sla_breach_days=round(mttr_days - 30, 1) \
| stats count as breach_count avg(mttr_days) as avg_mttr max(mttr_days) as max_mttr values(risk_vector) as risk_vectors by company_name \
| eval alert_msg="Critical findings exceeded 30-day SLA by avg of ".round(avg_mttr-30,1)." days" \
| table company_name breach_count avg_mttr max_mttr risk_vectors alert_msg
dispatch.earliest_time = -90d@d
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 5
alert.track = 1
action.email = 0
action.bitsight_webhook_alert = 0
action.bitsight_pagerduty_alert = 0

[Bitsight - MTTR SLA Breach - High Findings]
description = Alert when high severity findings exceed 60-day MTTR SLA threshold
search = index=main sourcetype="bitsight:findings" severity="high" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=round((last_epoch-first_epoch)/86400, 1) \
| where mttr_days > 60 \
| eval sla_breach_days=round(mttr_days - 60, 1) \
| stats count as breach_count avg(mttr_days) as avg_mttr max(mttr_days) as max_mttr values(risk_vector) as risk_vectors by company_name \
| eval alert_msg="High findings exceeded 60-day SLA by avg of ".round(avg_mttr-60,1)." days" \
| table company_name breach_count avg_mttr max_mttr risk_vectors alert_msg
dispatch.earliest_time = -180d@d
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 4
alert.track = 1
action.email = 0
action.bitsight_webhook_alert = 0

[Bitsight - MTTR SLA Breach - Medium Findings]
description = Alert when medium severity findings exceed 90-day MTTR SLA threshold
search = index=main sourcetype="bitsight:findings" severity="medium" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=round((last_epoch-first_epoch)/86400, 1) \
| where mttr_days > 90 \
| eval sla_breach_days=round(mttr_days - 90, 1) \
| stats count as breach_count avg(mttr_days) as avg_mttr max(mttr_days) as max_mttr values(risk_vector) as risk_vectors by company_name \
| eval alert_msg="Medium findings exceeded 90-day SLA by avg of ".round(avg_mttr-90,1)." days" \
| table company_name breach_count avg_mttr max_mttr risk_vectors alert_msg
dispatch.earliest_time = -365d@d
dispatch.latest_time = now
cron_schedule = 0 9 * * 1
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

[Bitsight - MTTR SLA Breach - Low Findings]
description = Alert when low severity findings exceed 180-day MTTR SLA threshold
search = index=main sourcetype="bitsight:findings" severity="low" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=round((last_epoch-first_epoch)/86400, 1) \
| where mttr_days > 180 \
| eval sla_breach_days=round(mttr_days - 180, 1) \
| stats count as breach_count avg(mttr_days) as avg_mttr max(mttr_days) as max_mttr values(risk_vector) as risk_vectors by company_name \
| eval alert_msg="Low findings exceeded 180-day SLA by avg of ".round(avg_mttr-180,1)." days" \
| table company_name breach_count avg_mttr max_mttr risk_vectors alert_msg
dispatch.earliest_time = -365d@d
dispatch.latest_time = now
cron_schedule = 0 9 1 * *
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 2
alert.track = 1

[Bitsight - MTTR Performance Degradation]
description = Alert when MTTR performance degrades week-over-week
search = index=main sourcetype="bitsight:findings" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=(last_epoch-first_epoch)/86400 \
| where mttr_days > 0 \
| eval week=strftime(last_epoch, "%Y-W%W") \
| stats avg(mttr_days) as avg_mttr by company_name severity week \
| sort company_name severity week \
| streamstats current=f last(avg_mttr) as prev_avg_mttr by company_name severity \
| eval mttr_change=avg_mttr - prev_avg_mttr \
| where mttr_change > 10 AND isnotnull(prev_avg_mttr) \
| eval alert_msg="MTTR increased by ".round(mttr_change,1)." days for ".severity." findings" \
| table company_name severity week avg_mttr prev_avg_mttr mttr_change alert_msg
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 8 * * 1
enableSched = 1
is_visible = 1
disabled = 0
alert.severity = 3
alert.track = 1

[Bitsight - MTTR Weekly Executive Summary]
description = Weekly MTTR performance summary for executive reporting
search = index=main sourcetype="bitsight:findings" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=(last_epoch-first_epoch)/86400 \
| where mttr_days > 0 \
| stats avg(mttr_days) as avg_mttr median(mttr_days) as median_mttr p90(mttr_days) as p90_mttr count as remediated_count by severity \
| eval sla_days=case(severity="critical", 30, severity="high", 60, severity="medium", 90, 1=1, 180) \
| eval sla_compliance=if(avg_mttr <= sla_days, "COMPLIANT", "BREACH") \
| eval avg_mttr=round(avg_mttr, 1), median_mttr=round(median_mttr, 1), p90_mttr=round(p90_mttr, 1) \
| table severity sla_days avg_mttr median_mttr p90_mttr remediated_count sla_compliance
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 7 * * 1
enableSched = 1
is_visible = 1
disabled = 0

# ============================================================================
# SCHEDULED PDF REPORTS
# ============================================================================

[Bitsight - Executive Weekly PDF Report]
description = Weekly executive summary PDF delivered every Monday
search = `bitsight_index` sourcetype="bitsight:portfolio" \
| dedup guid \
| stats avg(rating) as avg_rating count(eval(rating>=700)) as healthy count as total count(eval(rating<640)) as at_risk \
| eval portfolio_health=round((healthy/total)*100, 1)."%" \
| eval report_date=strftime(now(), "%Y-%m-%d") \
| appendcols [ \
  search `bitsight_index` sourcetype="bitsight:findings" (severity="critical" OR severity="severe") \
  | stats count as critical_findings \
] \
| appendcols [ \
  search `bitsight_index` sourcetype="bitsight:ratings:history" earliest=-7d \
  | stats earliest(rating) as week_start latest(rating) as week_end by company_guid \
  | eval improved=if(week_end > week_start, 1, 0), declined=if(week_end < week_start, 1, 0) \
  | stats sum(improved) as improved_count sum(declined) as declined_count \
] \
| table report_date total avg_rating portfolio_health critical_findings at_risk improved_count declined_count
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 7 * * 1
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = security-executives@company.com
action.email.subject = Bitsight Weekly Executive Summary - $result.report_date$
action.email.format = pdf
action.email.inline = 1
action.email.sendpdf = 1
action.email.pdfview = bitsight_overview

[Bitsight - Monthly Board Report PDF]
description = Monthly board-ready security report delivered on the 1st
search = `bitsight_index` sourcetype="bitsight:portfolio" \
| dedup guid \
| stats avg(rating) as avg_rating min(rating) as min_rating max(rating) as max_rating dc(guid) as total_companies dc(industry) as industries \
| eval report_period=strftime(relative_time(now(), "-1mon"), "%B %Y") \
| appendcols [ \
  search `bitsight_index` sourcetype="bitsight:findings" \
  | stats count as total_findings count(eval(severity="critical")) as critical count(eval(severity="high")) as high \
] \
| appendcols [ \
  search `bitsight_index` sourcetype="bitsight:ratings:history" earliest=-30d \
  | stats earliest(rating) as month_start latest(rating) as month_end by company_guid \
  | eval mom_change=month_end - month_start \
  | stats avg(mom_change) as avg_change count(eval(mom_change > 0)) as improved count(eval(mom_change < 0)) as declined \
] \
| eval avg_rating=round(avg_rating, 0), avg_change=round(avg_change, 1) \
| table report_period total_companies avg_rating min_rating max_rating industries total_findings critical high improved declined avg_change
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 6 1 * *
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = board@company.com, ciso@company.com
action.email.subject = Bitsight Monthly Security Report - $result.report_period$
action.email.format = pdf
action.email.inline = 1
action.email.sendpdf = 1
action.email.pdfview = bitsight_reports

[Bitsight - Quarterly Risk Assessment PDF]
description = Quarterly comprehensive risk report for board presentations
search = `bitsight_index` sourcetype="bitsight:portfolio" \
| dedup guid \
| stats avg(rating) as current_avg dc(guid) as total_companies by industry \
| appendcols [ \
  search `bitsight_index` sourcetype="bitsight:portfolio" earliest=-90d@d latest=-60d@d \
  | dedup guid \
  | stats avg(rating) as prev_quarter_avg \
] \
| eval qoq_change=round(current_avg - prev_quarter_avg, 1) \
| eval quarter=case( \
    tonumber(strftime(now(), "%m")) <= 3, "Q1", \
    tonumber(strftime(now(), "%m")) <= 6, "Q2", \
    tonumber(strftime(now(), "%m")) <= 9, "Q3", \
    1=1, "Q4" \
  )." ".strftime(now(), "%Y") \
| table quarter industry total_companies current_avg qoq_change
dispatch.earliest_time = -90d@d
dispatch.latest_time = now
cron_schedule = 0 6 1 1,4,7,10 *
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = board@company.com, executives@company.com
action.email.subject = Bitsight Quarterly Risk Assessment - $result.quarter$
action.email.format = pdf
action.email.inline = 1
action.email.sendpdf = 1

[Bitsight - MTTR Weekly Performance PDF]
description = Weekly MTTR SLA compliance report
search = index=main sourcetype="bitsight:findings" first_seen=* last_seen=* \
| eval first_epoch=strptime(first_seen, "%Y-%m-%dT%H:%M:%S"), last_epoch=strptime(last_seen, "%Y-%m-%dT%H:%M:%S") \
| eval mttr_days=(last_epoch-first_epoch)/86400 \
| where mttr_days > 0 \
| eval sla_days=case(severity="critical", 30, severity="high", 60, severity="medium", 90, 1=1, 180) \
| eval sla_met=if(mttr_days <= sla_days, 1, 0) \
| stats sum(sla_met) as compliant count as total avg(mttr_days) as avg_mttr by severity \
| eval compliance_pct=round((compliant/total)*100, 1)."%" \
| eval avg_mttr=round(avg_mttr, 1)." days" \
| eval report_week=strftime(now(), "%Y-W%W") \
| table report_week severity sla_days avg_mttr compliance_pct total
dispatch.earliest_time = -7d@d
dispatch.latest_time = now
cron_schedule = 0 7 * * 1
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = security-ops@company.com
action.email.subject = Bitsight MTTR Performance Report - Week $result.report_week$
action.email.format = pdf
action.email.inline = 1
action.email.sendpdf = 1
action.email.pdfview = bitsight_mttr_executive

[Bitsight - Daily Critical Alert Digest]
description = Daily digest of critical security alerts
search = `bitsight_index` (sourcetype="bitsight:alerts" OR sourcetype="bitsight:findings") \
| where severity IN ("critical", "severe", "high") \
| stats count as alert_count dc(company_name) as companies_affected values(company_name) as affected_list by severity \
| eval report_date=strftime(now(), "%Y-%m-%d") \
| where alert_count > 0 \
| table report_date severity alert_count companies_affected affected_list
dispatch.earliest_time = -24h@h
dispatch.latest_time = now
cron_schedule = 0 8 * * *
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = security-team@company.com
action.email.subject = Bitsight Daily Critical Alert Digest - $result.report_date$
action.email.format = html
action.email.inline = 1

[Bitsight - Vendor Risk Monthly Summary]
description = Monthly vendor risk summary for procurement and vendor management
search = `bitsight_index` sourcetype="bitsight:portfolio" tier IN ("Tier 1", "Tier 2", "Critical") \
| dedup guid \
| eval risk_level=case(rating<500, "Critical", rating<640, "High", rating<700, "Medium", 1=1, "Low") \
| stats count as vendor_count avg(rating) as avg_rating min(rating) as min_rating values(name) as vendors by risk_level tier \
| eval avg_rating=round(avg_rating, 0) \
| eval report_month=strftime(now(), "%B %Y") \
| table report_month tier risk_level vendor_count avg_rating min_rating
dispatch.earliest_time = -30d@d
dispatch.latest_time = now
cron_schedule = 0 6 1 * *
enableSched = 1
is_visible = 1
disabled = 0
action.email = 1
action.email.to = procurement@company.com, vendor-management@company.com
action.email.subject = Bitsight Vendor Risk Summary - $result.report_month$
action.email.format = pdf
action.email.inline = 1
